# Determine the internal path length of a tree

## 題目

>We define the internal path length of a multiway tree as the total sum of the path lengths from the root to all nodes of the tree. By this definition, the tree in the figure of problem 5.03 has an internal path length of 9. 
>
>Write a predicate ipl(Tree,IPL) for the flow pattern (+,-). 

用單元測試描述為：

[include](../../../tests/mtree/p504_test.py)

## 解題思路

多路樹的內部路徑長度被定義為從根節點到每一個節點的縂合。
從最簡單的個例開始分析。如下最一個只有一個節點的多路樹，其內部路徑為0。

```puml
digraph d {
    a
}
```

接着合併兩棵只有一個節點的多路樹，如下圖，兩棵子樹中每一個節點到根節點之間的路徑長度都加1了，而根節點的路徑長度為0。而內部路徑長度等於所有節點路徑長度的縂合，所以，合併後的內部路徑長度為`(0+1)+(0+1)+0=2`。

至此，可以歸納出：

1. 多路樹的節點集合等於所有子樹節點的合集加上根節點
2. 節點到根節點的路徑長度等於節點到子樹根節點的路徑長度再加一
3. 根節點到自身的路徑長度為0

基於上述規則，就可以設計出遞歸算法：

1. 求出子樹中所有的節點及它們到各自子樹根節點的路徑長度
2. 對所有子樹節點到各自子樹根節點的路徑長度加一即為其到根節的路徑長度。根節點到根節點的路徑長度為0。合起來就得到了多路樹中所有節點及路徑長度集合
3. 將多路樹中所有節點的路徑長度累加起來即為內部路徑長度

舉個例子，給定多路樹`(a,[(f,[(g,[])]),(c,[]),(b,[(d,[]),(e,[])])])`：

* 逐一求子樹中所有節點及到子樹根節點的路徑長度
  * 第一棵子樹`(f,[(g,[])])`
    * 逐一求子樹中所有節點及到子樹根節點的路徑長度
      * 第一棵子樹`(g,[])`
        * 沒有子樹，所以子樹所有節點集合為空
        * 對所有子樹節點路徑長度加1，因為所有子樹節點集合是空集，所以加完1後還是空集
        * 再加上根節點`g`，路徑長度為0，得到所有節點及路徑長度集合`[(g,0)]`
    * 合併所有子樹節點及路徑長度集合，得到`[(g,0)]`。對所有子樹節點的路徑長度加1，得到節點及路徑長度集合`[(g,1)]`
    * 再加上根節點`f`，路徑長度為0，得到本樹的所有節點及路徑長度集合`[(g,1),(f,0)]`
  * 第二棵子樹`(c,[])`
    * 沒有子樹，所以所有子樹節點集合為空
    * 對所有子樹節點路徑長度加1，因為所有子樹節點集合為空，所以加完1後還是空集
    * 再加上根節點`c`，路徑長度為0，得到本樹的所有節點及路徑長度集合`[(c,0)]`
  * 第三棵子樹`(b,[(d,[]),(e,[])])`
    * 逐一求子樹中所有節點及到子樹根節點的路徑長度
      * 第一棵子樹`(d,[])`
        * 沒有子樹，所以子樹所有節點集合為空
        * 對所有子樹節點路徑加1，因為所有子樹節點集合為空，所以加完1後還是空集
        * 再加上根節點`d`及路徑長度0，得到所有節點及路徑長度集合`[(d,0)]`
      * 第二棵子樹`(e,[])`
        * 沒有子樹，所以子樹所有節點集合為空
        * 對所有子樹節點路徑長度加1，因為所有子樹節點集合為空，所以加完1後還是空集
        * 再加上根節點`e`及路徑長度0，得到所有節點及路徑長度集合`[(e,0)]`
    * 合併所有子樹節點及路徑長度集合，得到`[(d,0),(e,0)]`。對所有子樹節點的路徑長度加1，得到節點集合`[(d,1),(e,1)]`
    * 再加上根節點`b`及路徑長度0，得到節點集合`[(b,0),(d,1),(e,1)]`
* 合併所有子樹節點及路徑長度集合，得到`[(g,1),(f,0),(c,0),(b,0),(d,1),(e,1)]`
* 對所有節點的路徑長度加1，得到`[(g,2),(f,1),(c,1),(b,1),(d,2),(e,2)]`
* 再加上根節點`a`及路徑長度0，得到節點及路徑長度集合`[(a,0),(g,2),(f,1),(c,1),(b,1),(d,2),(e,2)]`
* 最後再合計所有節點的路徑長度，即為內部路徑長度

代碼實現：

[include](../../../python99/mtree/p504.py)

`reduce`是Python標準庫提供的一個函數式的工具，其聲明為：

```python
reduce(function, iterable, initializer)
```

其功能是將`function`累積地、從左往右作用於`iterable`中的每一個元素。

reduce相當於如下代碼：

```python
def reduce(function, iterable, initializer=None):
    it = iter(iterable)
    if initializer is None:
        value = next(it)
    else:
        value = initializer
    for element in it:
        value = function(value, element)
    return value
```

這𥚃使用reduce實現節點及路徑長度集合合併和路徑長度累加。